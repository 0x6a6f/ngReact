<!DOCTYPE html>
<html class="no-js">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ng-repeat Benchmarks</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="//netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body ng-app="app">

    <section ng-controller="mainCtrl">

      <button ng-click="started = true" ng-hide="started" class="btn btn-primary">Start</button>

      <section ng-if="started">
        <div>
          <button ng-click="newData()" class="btn btn-primary">Reload table data</button>
        </div>
        <div class="table-responsive">
          <table class="table">
            <tbody>
              <tr ng-react-repeat data="data" alias="row" ng-click="clickHandler(row)">
                <td ng-bind="row.0"></td>
                <td ng-bind="row.1"></td>
                <td ng-bind="row.2"></td>
                <td ng-bind="row.3"></td>
                <td ng-bind="row.4"></td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </section>

    <script src="http://code.angularjs.org/1.2.1/angular.js"></script>
    <script src="bower_components/quick-ng-repeat/quick-ng-repeat.js"></script>
    <script src="bower_components/react/react.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.2/underscore-min.js"></script>
    <script src="bower_components/react/JSXTransformer.js"></script>
    <script type="text/jsx">
      /** @jsx React.DOM */
      window.reactRepeatUnit = React.createClass({
        render: function() {
          console.log('running reactRepeatUnit render');

          var data = this.props.data,
            scope = this.props.scope;

          var clickHandler = this.props.scope.$apply.bind(this.props.scope, this.props.scope.clickHandler.bind(null, data));

          var rowTranscluded = _.map(this.props.transcludedDom, function(domEl) {
            var boundValue = domEl.props['ng-bind'];
            var val = _.last(boundValue.split(scope.alias)).substring(1);

            return React.DOM[domEl.el].apply(null, [domEl.props].concat([data[val]]));
          });

          return React.DOM.tr.apply(null, [{ onClick : clickHandler }].concat(rowTranscluded));
        }
      });

      window.reactRepeat = React.createClass({
        render: function() {
          console.log('running reactRepeat render');

          var transcludedDom = _.compact(_.map(this.props.transcluded, function(node) {
            if (node.localName) {
              var properties = {};

              _.each(node.attributes, function(attr) {
                properties[attr.localName] = attr.value;
              });

              return {
                el: node.localName,
                props: properties
              };
            }
          }));

          var scope = this.props.scope;
          rows = _.map(this.props.scope.data, function(datum) {
            return reactRepeatUnit({scope: scope, data: datum, transcludedDom: transcludedDom});
          });

          var tr = React.DOM.tbody.apply(null, rows);
          return tr;
        }
      });
    </script>
    <script>
      angular.module('app', ['QuickList'])
        .controller('mainCtrl', ['$scope', function($scope) {
          $scope.data = [];
          $scope.started = true;

          $scope.newData = function() {

            $scope.data = [];

            for(var i = 0; i < 100; ++i) {
              $scope.data[i] = {};
              for(var j = 0; j < 5; ++j) {
                $scope.data[i][j] = Math.random();
              }
            }

            console.log('first row: ', $scope.data[0]);
          };

          $scope.clickHandler = function(index) {
            console.log(index);
          };

          $scope.newData();
        }])
        .directive('ngReactRepeat', function ($timeout) {
          return {
            restrict: 'A',
            transclude: true,
            replace: true,
            //todo: Remove this isolate scope and get the watchers to work instead for one way data binding
            scope: {
              data: '=',
              alias: '@'
            },
            controller: ['$scope', '$element', '$attrs', '$transclude', function ($scope, $element, $attrs, $transclude) {

              // $scope.alias = $attrs.alias;

              $scope.clickHandler = function(index) {
                console.log(index);
              };

              console.log('el', $element[0]);

              var parentReference = $element[0].offsetParent;

              $transclude(function(clone) {
                $scope.$watch('data', function(val) {

                  console.error('watcher firing, about to kick off React.renderComponent');
                  console.log('$el', $element);
                  console.log('parent', parentReference);

                  $timeout(function() {

                    React.renderComponent(
                      window.reactRepeat({
                        scope       : $scope, //_.extend($scope, { data: val }),
                        transcluded : clone,
                        rootUnit    : $element[0]
                      }),
                      parentReference
                    );

                  });
                }, true);
              });
            }]
          }
        });
    </script>
  </body>
</html>